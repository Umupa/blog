project:
  type: website

website:
  title: "Umupa"
  favicon: favicon.svg
  site-url: https://umupa.fun
  open-graph: true
  twitter-card: true
  search: false
  navbar: false
  comments:
    giscus:
      repo: umupa/blog
      repo-id: R_kgDONyPU6Q
      category: Announcements
      category-id: DIC_kwDONyPU6c4C0UA1
      mapping: pathname
      reactions-enabled: true
      loading: lazy
      input-position: bottom
      theme: catppuccin_latte
      language: zh-CN

include-in-header:
  - file: cloudflare.html

format:
  html:
    theme: cosmo
    css: styles.css
    page-layout: full
    include-before-body: _includes/custom-header.html
    include-in-header:
      - text: |
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.css">
    include-after-body:
      - _includes/date-formatter.html
      - text: |
          <script type="module">
            import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js';

            // 等待图片加载完成
            window.addEventListener('load', () => {
              console.log('[PhotoSwipe] 开始初始化...');

              // 查找所有文章中的图片（排除已包装和禁用的）
              const images = document.querySelectorAll('#quarto-document-content img.figure-img:not([no-pswp]), #quarto-document-content img.img-fluid:not([no-pswp]), main.content img:not([no-pswp])');
              console.log('[PhotoSwipe] 找到图片:', images.length);

              images.forEach(img => {
                // 跳过已包装的图片
                if (img.closest('a[data-pswp-width]')) {
                  return;
                }

                // 获取图片实际尺寸
                const width = img.getAttribute('width') || img.naturalWidth || 1920;
                const height = img.getAttribute('height') || img.naturalHeight || 1080;
                const src = img.getAttribute('src');

                // 创建 PhotoSwipe 链接
                const link = document.createElement('a');
                link.href = src;
                link.setAttribute('data-pswp-width', width);
                link.setAttribute('data-pswp-height', height);
                link.setAttribute('target', '_blank');
                link.style.cursor = 'zoom-in';

                // 包装图片
                img.parentNode.insertBefore(link, img);
                link.appendChild(img);
              });

              // 统计包装后的图片
              const wrappedImages = document.querySelectorAll('a[data-pswp-width]');
              console.log('[PhotoSwipe] 包装完成:', wrappedImages.length);

              // 初始化 PhotoSwipe
              const lightbox = new PhotoSwipeLightbox({
                gallery: '#quarto-document-content',
                children: 'a[data-pswp-width]',
                pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.esm.min.js'),

                // 预加载
                preload: [1, 2],

                // 缩放级别
                initialZoomLevel: 'fit',
                secondaryZoomLevel: 2.5,
                maxZoomLevel: 4,

                // 动画
                showHideAnimationType: 'zoom',

                // 交互
                bgClickAction: 'close',
                tapAction: 'toggle-controls',
                doubleTapAction: 'zoom',
                pinchToClose: true,

                // 控制栏
                zoom: true,
                close: true,
                counter: true,

                // 键盘
                escKey: true,
                arrowKeys: true
              });

              lightbox.on('uiRegister', function() {
                console.log('[PhotoSwipe] UI 注册完成');
              });

              lightbox.on('beforeOpen', function() {
                const items = lightbox.pswp.options.dataSource;
                console.log('[PhotoSwipe] 打开画廊，共', items.length || '?', '张图片');
              });

              lightbox.init();
              console.log('[PhotoSwipe] 初始化完成');
            });
          </script>
